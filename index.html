<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการสินค้าและขาย | Inventory & Sales Management</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.tailwindcss.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Animate.css for animations -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    
    <!-- Chart.js for Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- DataTables JS -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.tailwindcss.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <style>
        ::-webkit-scrollbar {
            width: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        
        /* Protection Styles */
        .protection-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 999999;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            backdrop-filter: blur(10px);
            display: none;
        }
        
        .alert-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 9999;
            max-width: 400px;
            width: 100%;
        }
        
        .alert {
            display: flex;
            align-items: center;
            padding: 1rem 1.25rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
            transform: translateX(120%);
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border-left-width: 4px;
        }
        
        .alert.show {
            transform: translateX(0);
        }
        
        .alert-success {
            background: linear-gradient(135deg, #064e3b 0%, #065f46 100%);
            border-left-color: #10b981;
            color: #d1fae5;
        }
        
        .alert-error {
            background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%);
            border-left-color: #ef4444;
            color: #fecaca;
        }
        
        .alert-warning {
            background: linear-gradient(135deg, #78350f 0%, #92400e 100%);
            border-left-color: #f59e0b;
            color: #fef3c7;
        }
        
        .alert-info {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            border-left-color: #3b82f6;
            color: #dbeafe;
        }
    </style>
    
    <!-- Protection Script (ป้องกันการ inspect) -->
    <script>
        // ระบบป้องกันการเปิด Developer Tools และการตรวจสอบโค้ด
        (function() {
            'use strict';
            
            // ฟังก์ชันแสดงคำเตือน
            function showProtectionWarning() {
                const overlay = document.getElementById('protectionOverlay');
                if (overlay) {
                    overlay.style.display = 'flex';
                    
                    // เพิ่มเอฟเฟกต์ให้กับหน้าเว็บ
                    document.body.style.filter = 'blur(5px)';
                    document.body.style.pointerEvents = 'none';
                    
                    setTimeout(() => {
                        overlay.style.display = 'none';
                        document.body.style.filter = 'none';
                        document.body.style.pointerEvents = 'auto';
                    }, 3000);
                }
            }
            
            // ป้องกันการคลิกขวา
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                showProtectionWarning();
                return false;
            });
            
            // ป้องกันการกดปุ่มลัด
            document.addEventListener('keydown', function(e) {
                // ป้องกัน F12
                if (e.keyCode === 123) {
                    e.preventDefault();
                    showProtectionWarning();
                    return false;
                }
                
                // ป้องกัน Ctrl+Shift+I
                if (e.ctrlKey && e.shiftKey && e.keyCode === 73) {
                    e.preventDefault();
                    showProtectionWarning();
                    return false;
                }
                
                // ป้องกัน Ctrl+Shift+J
                if (e.ctrlKey && e.shiftKey && e.keyCode === 74) {
                    e.preventDefault();
                    showProtectionWarning();
                    return false;
                }
                
                // ป้องกัน Ctrl+U
                if (e.ctrlKey && e.keyCode === 85) {
                    e.preventDefault();
                    showProtectionWarning();
                    return false;
                }
                
                // ป้องกัน Ctrl+S
                if (e.ctrlKey && e.keyCode === 83) {
                    e.preventDefault();
                    showProtectionWarning();
                    return false;
                }
            });
            
            // ตรวจจับการเปิด Developer Tools
            let devToolsOpened = false;
            const threshold = 160;
            
            const checkDevTools = function() {
                const widthThreshold = window.outerWidth - window.innerWidth > threshold;
                const heightThreshold = window.outerHeight - window.innerHeight > threshold;
                
                if (widthThreshold || heightThreshold) {
                    if (!devToolsOpened) {
                        devToolsOpened = true;
                        showProtectionWarning();
                    }
                } else {
                    devToolsOpened = false;
                }
            };
            
            // ตรวจสอบเป็นระยะ
            setInterval(checkDevTools, 500);
            
            // ตรวจสอบเมื่อหน้าต่างเปลี่ยนขนาด
            window.addEventListener('resize', checkDevTools);
            
            // สร้าง overlay สำหรับคำเตือน
            const overlay = document.createElement('div');
            overlay.id = 'protectionOverlay';
            overlay.className = 'protection-overlay';
            overlay.innerHTML = `
                <div style="background: linear-gradient(135deg, #dc2626, #991b1b); padding: 40px; border-radius: 20px; max-width: 500px; margin: 20px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.5);">
                    <div style="background: white; width: 100px; height: 100px; border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-shield-alt" style="font-size: 50px; color: #dc2626;"></i>
                    </div>
                    <h2 style="margin-bottom: 20px; color: white; font-size: 28px;">⚠️ ระบบป้องกันการเข้าถึงโค้ด</h2>
                    <p style="font-size: 18px; margin-bottom: 20px; color: white; line-height: 1.6;">
                        ตรวจพบการพยายามเข้าถึงโค้ดโปรแกรม!
                    </p>
                    <p style="font-size: 16px; opacity: 0.9; color: #fecaca; margin-bottom: 25px;">
                        การกระทำนี้อาจทำให้ระบบถูกระงับการใช้งาน
                    </p>
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin-top: 20px;">
                        <p style="color: #fecaca; font-size: 14px; margin: 0;">
                            <i class="fas fa-info-circle"></i> กรุณาอย่าทำการ inspect หรือเปิด developer tools
                        </p>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
            
            console.log('ระบบป้องกันโค้ดได้เริ่มทำงานแล้ว');
        })();
    </script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <!-- Alert Container -->
    <div id="alertContainer" class="alert-container"></div>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="text-center">
            <div class="inline-block p-6 bg-gray-800 rounded-2xl shadow-2xl animate__animated animate__pulse">
                <div class="w-16 h-16 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-white text-lg font-medium" id="loadingMessage">กำลังโหลดข้อมูล...</p>
                <p class="text-gray-400 text-sm mt-2 animate-pulse">กรุณารอสักครู่</p>
            </div>
        </div>
    </div>

    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center p-4 page-transition">
        <div class="bg-gray-800 rounded-2xl shadow-2xl overflow-hidden w-full max-w-md animate__animated animate__fadeIn">
            <!-- Header -->
            <div class="bg-gradient-to-r from-indigo-700 to-purple-700 p-8 text-center relative overflow-hidden">
                <div class="floating inline-block p-4 bg-white/10 rounded-full mb-4 relative z-10">
                    <i class="fas fa-cash-register text-white text-3xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-white relative z-10">ระบบจัดการสินค้าและขาย</h1>
                <p class="text-indigo-200 mt-2 relative z-10">Inventory & Sales Management System</p>
            </div>
            
            <!-- Login Form -->
            <div class="p-8">
                <h2 class="text-2xl font-bold text-white mb-2">เข้าสู่ระบบ</h2>
                <p class="text-gray-400 mb-6">กรุณากรอกข้อมูลเพื่อเข้าสู่ระบบ</p>
                
                <form id="loginForm">
                    <div class="space-y-5">
                        <div>
                            <label for="username" class="block text-sm font-medium text-gray-300 mb-2">
                                <i class="fas fa-user mr-2"></i>ชื่อผู้ใช้
                            </label>
                            <input 
                                type="text" 
                                id="username" 
                                required 
                                placeholder="กรอกชื่อผู้ใช้"
                                class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-white placeholder-gray-400"
                            >
                        </div>
                        
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-300 mb-2">
                                <i class="fas fa-lock mr-2"></i>รหัสผ่าน
                            </label>
                            <input 
                                type="password" 
                                id="password" 
                                required 
                                placeholder="กรอกรหัสผ่าน"
                                class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-white placeholder-gray-400"
                            >
                        </div>
                        
                        <div class="pt-4">
                            <button 
                                type="submit" 
                                id="loginBtn"
                                class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center space-x-2"
                            >
                                <i class="fas fa-sign-in-alt"></i>
                                <span>เข้าสู่ระบบ</span>
                            </button>
                        </div>
                    </div>
                </form>
                
                <!-- Demo Accounts -->
                <div class="mt-8 pt-6 border-t border-gray-700">
                    <h3 class="text-sm font-medium text-gray-300 mb-3 flex items-center">
                        <i class="fas fa-info-circle mr-2 text-yellow-400"></i> บัญชีสำหรับทดสอบระบบ:
                    </h3>
                    <div class="space-y-2 text-sm">
                        <div class="bg-gray-900/50 p-3 rounded-lg">
                            <p class="text-gray-400"><span class="font-medium text-gray-300">ผู้ใช้ทั่วไป:</span> user / user123</p>
                        </div>
                        <div class="bg-gray-900/50 p-3 rounded-lg">
                            <p class="text-gray-400"><span class="font-medium text-gray-300">ผู้จัดการ:</span> manager / manager123</p>
                        </div>
                        <div class="bg-gray-900/50 p-3 rounded-lg">
                            <p class="text-gray-400"><span class="font-medium text-gray-300">ผู้ดูแลระบบ:</span> admin / admin123</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="appContainer" class="hidden">
        <!-- Header -->
        <header class="bg-gray-800 shadow-lg sticky top-0 z-50">
            <div class="container mx-auto px-4 py-4">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="flex items-center space-x-3 mb-4 md:mb-0">
                        <a href="#" id="homeBtn" class="flex items-center space-x-3">
                            <div class="bg-indigo-600 p-3 rounded-lg">
                                <i class="fas fa-cash-register text-white text-2xl"></i>
                            </div>
                            <div>
                                <h1 class="text-2xl md:text-3xl font-bold">ระบบจัดการสินค้าและขาย</h1>
                                <p class="text-gray-400 text-sm">ระบบจัดการสินค้าและขายแบบครบวงจร</p>
                            </div>
                        </a>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <!-- User Info -->
                        <div class="hidden md:flex items-center space-x-3 bg-gray-700 px-4 py-2 rounded-lg cursor-pointer" id="userInfoBtn">
                            <div class="w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center">
                                <i class="fas fa-user text-white"></i>
                            </div>
                            <div>
                                <p class="font-medium" id="currentUsername">กำลังโหลด...</p>
                                <div class="flex items-center space-x-2">
                                    <span id="userRoleBadge" class="role-badge role-user">ผู้ใช้ทั่วไป</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Logout Button -->
                        <button id="logoutBtn" class="bg-gradient-to-r from-gray-700 to-gray-600 hover:from-gray-600 hover:to-gray-500 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>ออกจากระบบ</span>
                        </button>
                    </div>
                </div>
                
                <!-- Navigation -->
                <div class="mt-4 flex flex-wrap gap-2 border-t border-gray-700 pt-4">
                    <button id="navDashboard" class="nav-link active">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>แดชบอร์ด</span>
                    </button>
                    <button id="navProducts" class="nav-link">
                        <i class="fas fa-box"></i>
                        <span>จัดการสินค้า</span>
                    </button>
                    <button id="navSales" class="nav-link">
                        <i class="fas fa-shopping-cart"></i>
                        <span>ขายสินค้า</span>
                    </button>
                    <button id="navSalesReport" class="nav-link">
                        <i class="fas fa-chart-line"></i>
                        <span>รายงานการขาย</span>
                    </button>
                    <button id="navUsers" class="nav-link">
                        <i class="fas fa-users"></i>
                        <span>จัดการผู้ใช้</span>
                    </button>
                    <button id="navSettings" class="nav-link">
                        <i class="fas fa-cog"></i>
                        <span>ตั้งค่าระบบ</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-8">
            <!-- Dashboard Page -->
            <div id="dashboardPage" class="page-content">
                <!-- Welcome Message -->
                <div class="bg-gradient-to-r from-gray-800 to-gray-700 rounded-xl p-6 shadow-lg mb-8">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                        <div>
                            <h2 class="text-2xl font-bold mb-2">ยินดีต้อนรับ, <span id="welcomeUsername" class="text-indigo-300">ผู้ใช้</span>!</h2>
                            <p class="text-gray-300" id="welcomeMessage">คุณกำลังใช้ระบบจัดการสินค้าและขายแบบครบวงจร</p>
                        </div>
                    </div>
                </div>
                
                <!-- Statistics Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-gray-400 text-sm">จำนวนสินค้าทั้งหมด</p>
                                <h3 id="totalProducts" class="text-3xl font-bold mt-2">0</h3>
                            </div>
                            <div class="bg-indigo-900 p-4 rounded-lg">
                                <i class="fas fa-box text-indigo-300 text-2xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-gray-400 text-sm">มูลค่าสินค้าทั้งหมด</p>
                                <h3 id="totalValue" class="text-3xl font-bold mt-2">฿0</h3>
                            </div>
                            <div class="bg-green-900 p-4 rounded-lg">
                                <i class="fas fa-coins text-green-300 text-2xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-gray-400 text-sm">ยอดขายวันนี้</p>
                                <h3 id="todaySales" class="text-3xl font-bold mt-2">฿0</h3>
                            </div>
                            <div class="bg-yellow-900 p-4 rounded-lg">
                                <i class="fas fa-money-bill-wave text-yellow-300 text-2xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-gray-400 text-sm">สินค้าหมดสต๊อก</p>
                                <h3 id="outOfStock" class="text-3xl font-bold mt-2">0</h3>
                            </div>
                            <div class="bg-red-900 p-4 rounded-lg">
                                <i class="fas fa-exclamation-triangle text-red-300 text-2xl"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Sales -->
                <div class="bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-history mr-2 text-indigo-400"></i> การขายล่าสุด
                    </h2>
                    <div id="recentSales" class="space-y-3">
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-clock text-2xl mb-2"></i>
                            <p>ยังไม่มีข้อมูลการขายล่าสุด</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Products Management Page -->
            <div id="productsPage" class="page-content hidden">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
                    <div>
                        <h2 class="text-2xl font-bold flex items-center">
                            <i class="fas fa-box mr-2 text-indigo-400"></i> จัดการข้อมูลสินค้า
                        </h2>
                        <p class="text-gray-400 text-sm mt-1">เพิ่ม แก้ไข ลบ และจัดการข้อมูลสินค้าทั้งหมด</p>
                    </div>
                    <div class="mt-4 md:mt-0 flex space-x-2">
                        <button id="addProductMainBtn" class="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2">
                            <i class="fas fa-plus"></i>
                            <span>เพิ่มสินค้าใหม่</span>
                        </button>
                        <button id="exportProductsBtn" class="bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2">
                            <i class="fas fa-download"></i>
                            <span>ส่งออกข้อมูล</span>
                        </button>
                    </div>
                </div>
                
                <!-- Product Table -->
                <div class="bg-gray-800 rounded-xl shadow-lg overflow-hidden mb-8">
                    <div class="p-6 border-b border-gray-700">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                            <div>
                                <h3 class="text-lg font-bold">รายการสินค้าทั้งหมด</h3>
                                <p class="text-gray-400 text-sm mt-1" id="productsTableInfo">แสดงข้อมูลสินค้าทั้งหมดในระบบ</p>
                            </div>
                            <div class="mt-3 md:mt-0">
                                <div class="flex items-center space-x-2">
                                    <div class="relative">
                                        <input type="text" id="productSearch" placeholder="ค้นหาสินค้า..." class="bg-gray-700 border border-gray-600 rounded-lg pl-10 pr-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-transparent w-64">
                                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-4">
                        <table id="productsTable" class="min-w-full divide-y divide-gray-700">
                            <thead>
                                <tr class="bg-gray-900">
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">รหัสสินค้า</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">ชื่อสินค้า</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">ประเภท</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">จำนวน</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">ราคา/หน่วย</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">มูลค่ารวม</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">สถานะ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">การจัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody" class="divide-y divide-gray-700">
                                <!-- ข้อมูลจะถูกเพิ่มโดย JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Sales Page -->
            <div id="salesPage" class="page-content hidden">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
                    <div>
                        <h2 class="text-2xl font-bold flex items-center">
                            <i class="fas fa-shopping-cart mr-2 text-green-400"></i> ขายสินค้า
                        </h2>
                        <p class="text-gray-400 text-sm mt-1">เลือกสินค้าและดำเนินการขาย พร้อมตัดสต๊อกอัตโนมัติ</p>
                    </div>
                    <div class="mt-4 md:mt-0 flex space-x-2">
                        <button id="newSaleBtn" class="bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2">
                            <i class="fas fa-receipt"></i>
                            <span>เริ่มการขายใหม่</span>
                        </button>
                    </div>
                </div>
                
                <!-- Sales Interface -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Left Column: Product Selection -->
                    <div class="lg:col-span-2">
                        <!-- Product Search and Filter -->
                        <div class="bg-gray-800 rounded-xl shadow-lg p-6 mb-6">
                            <h3 class="text-lg font-bold mb-4 flex items-center">
                                <i class="fas fa-search mr-2 text-indigo-400"></i> ค้นหาและเลือกสินค้า
                            </h3>
                            
                            <!-- Product List -->
                            <div class="bg-gray-900 rounded-lg p-4 cart-scroll" style="max-height: 500px;">
                                <div id="salesProductList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="text-center py-12 text-gray-500">
                                        <i class="fas fa-box-open text-3xl mb-3"></i>
                                        <p>กำลังโหลดสินค้า...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Current Sale Details -->
                        <div class="bg-gray-800 rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-bold mb-4 flex items-center">
                                <i class="fas fa-receipt mr-2 text-yellow-400"></i> รายการขายปัจจุบัน
                            </h3>
                            <div class="mb-4">
                                <div class="flex items-center space-x-4 mb-4">
                                    <div class="flex-1">
                                        <label for="customerName" class="block text-sm font-medium text-gray-300 mb-1">ชื่อลูกค้า</label>
                                        <input type="text" id="customerName" placeholder="ลูกค้าทั่วไป" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                    </div>
                                    <div class="flex-1">
                                        <label for="paymentMethod" class="block text-sm font-medium text-gray-300 mb-1">วิธีการชำระเงิน</label>
                                        <select id="paymentMethod" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                            <option value="เงินสด">เงินสด</option>
                                            <option value="โอนเงิน">โอนเงิน</option>
                                            <option value="บัตรเครดิต">บัตรเครดิต</option>
                                            <option value="QR Payment">QR Payment</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Cart Items -->
                            <div class="bg-gray-900 rounded-lg p-4 cart-scroll mb-4" style="max-height: 300px;">
                                <div id="cartItems" class="space-y-3">
                                    <div class="text-center py-8 text-gray-500">
                                        <i class="fas fa-shopping-cart text-2xl mb-2"></i>
                                        <p>ยังไม่มีสินค้าในตะกร้า</p>
                                        <p class="text-sm">เลือกสินค้าจากรายการด้านบนเพื่อเพิ่มลงในตะกร้า</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Cart Summary -->
                            <div class="bg-gray-900 rounded-lg p-4">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-gray-400">รวมทั้งหมด</span>
                                    <span id="cartSubtotal" class="text-xl font-bold">฿0.00</span>
                                </div>
                                <div class="flex justify-between items-center mb-4">
                                    <span class="text-gray-400">ส่วนลด</span>
                                    <div class="flex items-center space-x-2">
                                        <input type="number" id="discountAmount" min="0" value="0" class="w-24 px-3 py-1 bg-gray-700 border border-gray-600 rounded text-right">
                                        <span>฿</span>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center border-t border-gray-700 pt-4 mb-6">
                                    <span class="text-lg font-bold">ยอดรวมสุทธิ</span>
                                    <span id="cartTotal" class="text-2xl font-bold text-green-400">฿0.00</span>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <button id="clearCartBtn" class="py-3 bg-gray-700 hover:bg-gray-600 rounded-lg font-medium">
                                        <i class="fas fa-trash-alt mr-2"></i> ล้างตะกร้า
                                    </button>
                                    <button id="completeSaleBtn" class="py-3 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 rounded-lg font-medium">
                                        <i class="fas fa-check-circle mr-2"></i> บันทึกการขาย
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Column: Sales Info -->
                    <div class="space-y-6">
                        <!-- Today's Sales Stats -->
                        <div class="bg-gray-800 rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-bold mb-4 flex items-center">
                                <i class="fas fa-chart-line mr-2 text-green-400"></i> สถิติการขายวันนี้
                            </h3>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-400">จำนวนการขาย</span>
                                    <span id="todaySalesCount" class="font-bold text-lg">0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-400">ยอดขายรวม</span>
                                    <span id="todaySalesTotal" class="font-bold text-lg text-green-400">฿0.00</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Recent Sales -->
                        <div class="bg-gray-800 rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-bold mb-4 flex items-center">
                                <i class="fas fa-history mr-2 text-indigo-400"></i> การขายล่าสุด
                            </h3>
                            <div id="recentSalesList" class="space-y-3">
                                <div class="text-center py-4 text-gray-500">
                                    <i class="fas fa-receipt text-xl mb-2"></i>
                                    <p class="text-sm">ยังไม่มีการขายล่าสุด</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sales Report Page -->
            <div id="salesReportPage" class="page-content hidden">
                <div class="mb-8">
                    <h2 class="text-2xl font-bold flex items-center">
                        <i class="fas fa-chart-line mr-2 text-green-400"></i> รายงานการขาย
                    </h2>
                    <p class="text-gray-400 text-sm mt-1">วิเคราะห์ข้อมูลและสรุปรายงานการขายรายวันและรายเดือน</p>
                </div>
                
                <!-- Report Filters -->
                <div class="bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-filter mr-2 text-indigo-400"></i> ตัวกรองรายงาน
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">วันที่เริ่มต้น</label>
                            <input type="date" id="reportStartDate" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">วันที่สิ้นสุด</label>
                            <input type="date" id="reportEndDate" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        </div>
                        <div class="flex items-end">
                            <button id="generateReportBtn" class="w-full py-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 rounded-lg font-medium">
                                <i class="fas fa-chart-bar mr-2"></i> สร้างรายงาน
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Sales Statistics -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-gradient-to-r from-indigo-800 to-purple-800 rounded-xl p-6 shadow-lg">
                        <div class="flex items-center">
                            <div class="mr-4">
                                <i class="fas fa-receipt text-3xl text-white"></i>
                            </div>
                            <div>
                                <p class="text-gray-300 text-sm">จำนวนการขาย</p>
                                <p id="totalSalesCount" class="text-2xl font-bold">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-green-800 to-emerald-800 rounded-xl p-6 shadow-lg">
                        <div class="flex items-center">
                            <div class="mr-4">
                                <i class="fas fa-money-bill-wave text-3xl text-white"></i>
                            </div>
                            <div>
                                <p class="text-gray-300 text-sm">ยอดขายรวม</p>
                                <p id="totalSalesAmount" class="text-2xl font-bold">฿0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-blue-800 to-cyan-800 rounded-xl p-6 shadow-lg">
                        <div class="flex items-center">
                            <div class="mr-4">
                                <i class="fas fa-boxes text-3xl text-white"></i>
                            </div>
                            <div>
                                <p class="text-gray-300 text-sm">สินค้าที่ขายได้</p>
                                <p id="totalItemsSold" class="text-2xl font-bold">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-yellow-800 to-orange-800 rounded-xl p-6 shadow-lg">
                        <div class="flex items-center">
                            <div class="mr-4">
                                <i class="fas fa-percentage text-3xl text-white"></i>
                            </div>
                            <div>
                                <p class="text-gray-300 text-sm">ยอดขายเฉลี่ย/ครั้ง</p>
                                <p id="averageSaleAmount" class="text-2xl font-bold">฿0</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Report Tabs -->
                <div class="flex border-b border-gray-700 mb-6">
                    <div class="tab active" data-tab="dailyReport">รายงานรายวัน</div>
                    <div class="tab" data-tab="salesListReport">รายการขายทั้งหมด</div>
                </div>
                
                <!-- Daily Report -->
                <div id="dailyReport" class="tab-content">
                    <div class="bg-gray-800 rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-bold mb-4">ข้อมูลการขายรายวัน</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-700">
                                <thead>
                                    <tr class="bg-gray-900">
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">วันที่</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">จำนวนการขาย</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">ยอดขายรวม</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">สินค้าที่ขายได้</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">ยอดขายเฉลี่ย</th>
                                    </tr>
                                </thead>
                                <tbody id="dailySalesTableBody" class="divide-y divide-gray-700">
                                    <tr>
                                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                                            <i class="fas fa-chart-line text-xl mb-2"></i>
                                            <p>ไม่มีข้อมูลการขาย</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Sales List Report -->
                <div id="salesListReport" class="tab-content hidden">
                    <div class="bg-gray-800 rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-bold mb-4">รายการขายทั้งหมด</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-700">
                                <thead>
                                    <tr class="bg-gray-900">
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">เลขที่ใบเสร็จ</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">ลูกค้า</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">วันที่ขาย</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">จำนวนสินค้า</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">ยอดรวม</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">การชำระเงิน</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">ผู้ขาย</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">การจัดการ</th>
                                    </tr>
                                </thead>
                                <tbody id="salesListTableBody" class="divide-y divide-gray-700">
                                    <tr>
                                        <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                                            <i class="fas fa-receipt text-xl mb-2"></i>
                                            <p>ไม่มีข้อมูลการขาย</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Management Page -->
            <div id="usersPage" class="page-content hidden">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
                    <div>
                        <h2 class="text-2xl font-bold flex items-center">
                            <i class="fas fa-users mr-2 text-indigo-400"></i> จัดการข้อมูลผู้ใช้
                        </h2>
                        <p class="text-gray-400 text-sm mt-1">เพิ่ม แก้ไข ลบ และจัดการสิทธิ์ผู้ใช้ทั้งหมดในระบบ</p>
                    </div>
                    <div class="mt-4 md:mt-0 flex space-x-2">
                        <button id="addUserBtn" class="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2">
                            <i class="fas fa-user-plus"></i>
                            <span>เพิ่มผู้ใช้ใหม่</span>
                        </button>
                    </div>
                </div>
                
                <!-- Users Table -->
                <div class="bg-gray-800 rounded-xl shadow-lg overflow-hidden mb-8">
                    <div class="p-6 border-b border-gray-700">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                            <div>
                                <h3 class="text-lg font-bold">รายการผู้ใช้ทั้งหมด</h3>
                                <p class="text-gray-400 text-sm mt-1">แสดงข้อมูลผู้ใช้ทั้งหมดในระบบ</p>
                            </div>
                            <div class="mt-3 md:mt-0">
                                <div class="flex items-center space-x-2">
                                    <div class="relative">
                                        <input type="text" id="userSearch" placeholder="ค้นหาผู้ใช้..." class="bg-gray-700 border border-gray-600 rounded-lg pl-10 pr-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-transparent w-64">
                                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-4">
                        <table id="usersTable" class="min-w-full divide-y divide-gray-700">
                            <thead>
                                <tr class="bg-gray-900">
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">ชื่อผู้ใช้</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">ชื่อ-นามสกุล</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">บทบาท</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">สถานะ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">ล็อกอินล่าสุด</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">การจัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody" class="divide-y divide-gray-700">
                                <!-- ข้อมูลจะถูกเพิ่มโดย JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Settings Page -->
            <div id="settingsPage" class="page-content hidden">
                <div class="mb-8">
                    <h2 class="text-2xl font-bold flex items-center">
                        <i class="fas fa-cog mr-2 text-indigo-400"></i> ตั้งค่าระบบ
                    </h2>
                    <p class="text-gray-400 text-sm mt-1">จัดการการตั้งค่าระบบและปรับแต่งการทำงาน</p>
                </div>
                
                <!-- Database Management -->
                <div class="bg-gray-800 rounded-xl p-6 shadow-lg mb-8">
                    <h3 class="text-lg font-bold mb-4">จัดการฐานข้อมูล</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button id="backupDataBtn" class="bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center space-x-2">
                            <i class="fas fa-database"></i>
                            <span>สำรองข้อมูล</span>
                        </button>
                        <button id="resetDemoDataBtn" class="bg-gradient-to-r from-yellow-600 to-orange-600 hover:from-yellow-700 hover:to-orange-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center space-x-2">
                            <i class="fas fa-redo"></i>
                            <span>รีเซ็ตข้อมูลตัวอย่าง</span>
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-800 border-t border-gray-700 py-6 mt-8">
            <div class="container mx-auto px-4">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="mb-4 md:mb-0">
                        <p class="text-gray-400">
                            <i class="fas fa-cube mr-1"></i> ระบบจัดการสินค้าและขายด้วย Firebase
                        </p>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Modal สำหรับเพิ่ม/แก้ไขสินค้า -->
    <div id="productModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-md mx-4">
            <div class="p-6 border-b border-gray-700">
                <h3 id="modalProductTitle" class="text-xl font-bold">เพิ่มสินค้าใหม่</h3>
            </div>
            
            <form id="productForm" class="p-6">
                <input type="hidden" id="productId">
                
                <div class="space-y-4">
                    <div>
                        <label for="productCode" class="block text-sm font-medium text-gray-300 mb-1">รหัสสินค้า *</label>
                        <input type="text" id="productCode" required class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label for="productName" class="block text-sm font-medium text-gray-300 mb-1">ชื่อสินค้า *</label>
                        <input type="text" id="productName" required class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label for="productCategory" class="block text-sm font-medium text-gray-300 mb-1">ประเภท *</label>
                        <select id="productCategory" required class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                            <option value="">เลือกประเภทสินค้า</option>
                            <option value="อิเล็กทรอนิกส์">อิเล็กทรอนิกส์</option>
                            <option value="เครื่องเขียน">เครื่องเขียน</option>
                            <option value="เฟอร์นิเจอร์">เฟอร์นิเจอร์</option>
                            <option value="เครื่องดื่ม">เครื่องดื่ม</option>
                            <option value="อาหาร">อาหาร</option>
                            <option value="อื่นๆ">อื่นๆ</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="productQuantity" class="block text-sm font-medium text-gray-300 mb-1">จำนวน *</label>
                            <input type="number" id="productQuantity" required min="0" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label for="productPrice" class="block text-sm font-medium text-gray-300 mb-1">ราคาต่อหน่วย *</label>
                            <input type="number" id="productPrice" required min="0" step="0.01" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 mt-8">
                    <button type="button" id="cancelProductModalBtn" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg">ยกเลิก</button>
                    <button type="submit" id="saveProductBtn" class="px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 rounded-lg">บันทึกข้อมูล</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal สำหรับเพิ่ม/แก้ไขผู้ใช้ -->
    <div id="userModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-md mx-4">
            <div class="p-6 border-b border-gray-700">
                <h3 id="modalUserTitle" class="text-xl font-bold">เพิ่มผู้ใช้ใหม่</h3>
            </div>
            
            <form id="userForm" class="p-6">
                <input type="hidden" id="userId">
                
                <div class="space-y-4">
                    <div>
                        <label for="newUsername" class="block text-sm font-medium text-gray-300 mb-1">ชื่อผู้ใช้ *</label>
                        <input type="text" id="newUsername" required class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label for="newPassword" class="block text-sm font-medium text-gray-300 mb-1">รหัสผ่าน *</label>
                        <input type="password" id="newPassword" required class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label for="fullName" class="block text-sm font-medium text-gray-300 mb-1">ชื่อ-นามสกุล *</label>
                        <input type="text" id="fullName" required class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label for="userRole" class="block text-sm font-medium text-gray-300 mb-1">บทบาท *</label>
                        <select id="userRole" required class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                            <option value="">เลือกบทบาทผู้ใช้</option>
                            <option value="user">ผู้ใช้ทั่วไป</option>
                            <option value="manager">ผู้จัดการ</option>
                            <option value="admin">ผู้ดูแลระบบ</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 mt-8">
                    <button type="button" id="cancelUserModalBtn" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg">ยกเลิก</button>
                    <button type="submit" id="saveUserBtn" class="px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 rounded-lg">บันทึกข้อมูล</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal สำหรับแสดงใบเสร็จ -->
    <div id="receiptModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-md mx-4">
            <div class="p-6 border-b border-gray-700">
                <h3 class="text-xl font-bold">ใบเสร็จรับเงิน</h3>
            </div>
            
            <div class="p-6">
                <div id="receiptContent" class="receipt bg-white text-black p-6 rounded-lg">
                    <div class="text-center mb-4">
                        <h2 class="text-xl font-bold">ร้านค้าทั่วไป</h2>
                        <p class="text-sm">ที่อยู่: 123 ถนนหลัก อำเภอเมือง จังหวัดตัวอย่าง</p>
                        <p class="text-sm">โทร: 012-345-6789</p>
                    </div>
                    
                    <div class="mb-4">
                        <div class="flex justify-between mb-2">
                            <span>เลขที่ใบเสร็จ:</span>
                            <span id="receiptNumber" class="font-bold">S001</span>
                        </div>
                        <div class="flex justify-between mb-2">
                            <span>วันที่:</span>
                            <span id="receiptDate"></span>
                        </div>
                        <div class="flex justify-between mb-4">
                            <span>ลูกค้า:</span>
                            <span id="receiptCustomer">ลูกค้าทั่วไป</span>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="receipt-line"></div>
                        <div id="receiptItems">
                            <!-- Items will be added here -->
                        </div>
                        <div class="receipt-line"></div>
                    </div>
                    
                    <div class="text-right">
                        <div class="flex justify-between mb-1">
                            <span>รวม:</span>
                            <span id="receiptSubtotal">฿0.00</span>
                        </div>
                        <div class="flex justify-between mb-1">
                            <span>ส่วนลด:</span>
                            <span id="receiptDiscount">฿0.00</span>
                        </div>
                        <div class="flex justify-between font-bold text-lg mb-4">
                            <span>รวมสุทธิ:</span>
                            <span id="receiptTotal">฿0.00</span>
                        </div>
                        <div class="flex justify-between mb-1">
                            <span>วิธีการชำระเงิน:</span>
                            <span id="receiptPaymentMethod">เงินสด</span>
                        </div>
                    </div>
                    
                    <div class="text-center mt-6 pt-4 border-t border-dashed border-gray-400">
                        <p class="text-sm">ขอบคุณที่ใช้บริการ</p>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 mt-8">
                    <button type="button" id="closeReceiptBtn" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg">ปิด</button>
                    <button type="button" id="printReceiptBtn" class="px-4 py-2 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 rounded-lg">
                        <i class="fas fa-print mr-2"></i> พิมพ์ใบเสร็จ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Dialog -->
    <div id="confirmationDialog" class="confirmation-dialog hidden">
        <div class="confirmation-header">
            <div id="confirmationIcon" class="confirmation-icon">
                <i class="fas fa-exclamation-triangle text-yellow-500"></i>
            </div>
            <h3 id="confirmationTitle" class="text-xl font-bold">ยืนยันการดำเนินการ</h3>
        </div>
        <div class="confirmation-body">
            <p id="confirmationMessage" class="text-gray-300">คุณแน่ใจหรือไม่ว่าต้องการดำเนินการนี้?</p>
        </div>
        <div class="confirmation-footer">
            <button id="cancelConfirmBtn" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg">ยกเลิก</button>
            <button id="confirmActionBtn" class="px-4 py-2 bg-gradient-to-r from-red-600 to-pink-600 hover:from-red-700 hover:to-pink-700 rounded-lg">ยืนยัน</button>
        </div>
    </div>

    <!-- Firebase Configuration Script -->
    <script id="firebaseConfigScript">
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAc9BtiDc0pOeX4uJpIOYLBTZ9DM6MkFCM",
            authDomain: "inventory-c74e1.firebaseapp.com",
            databaseURL: "https://inventory-c74e1-default-rtdb.firebaseio.com",
            projectId: "inventory-c74e1",
            storageBucket: "inventory-c74e1.firebasestorage.app",
            messagingSenderId: "95313330186",
            appId: "1:95313330186:web:b8b5b675a8e829e76bdff3",
            measurementId: "G-Y069B1FRNC"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        console.log("Firebase initialized successfully!");
    </script>

    <!-- Main Application Script -->
    <script>
        // ตัวแปรหลักของแอพพลิเคชัน
        let products = [];
        let users = [];
        let sales = [];
        let currentUser = null;
        let userToDelete = null;
        let productToDelete = null;
        
        // ตัวแปรสำหรับระบบขาย
        let cart = [];
        let saleCounter = 1;
        
        // สิทธิ์การใช้งานตามบทบาท
        const rolePermissions = {
            'admin': {
                canView: true,
                canAdd: true,
                canEdit: true,
                canDelete: true,
                canManageUsers: true,
                canViewReports: true,
                canManageSettings: true,
                canSell: true,
                canViewSales: true
            },
            'manager': {
                canView: true,
                canAdd: true,
                canEdit: true,
                canDelete: false,
                canManageUsers: false,
                canViewReports: true,
                canManageSettings: false,
                canSell: true,
                canViewSales: true
            },
            'user': {
                canView: true,
                canAdd: true,
                canEdit: true,
                canDelete: false,
                canManageUsers: false,
                canViewReports: false,
                canManageSettings: false,
                canSell: true,
                canViewSales: false
            }
        };
        
        // DOM Elements
        const loginPage = document.getElementById('loginPage');
        const appContainer = document.getElementById('appContainer');
        const loadingOverlay = document.getElementById('loadingOverlay');
        
        // ==================== ALERT SYSTEM ====================
        
        function showAlert(type, title, message, duration = 5000) {
            const alertContainer = document.getElementById('alertContainer');
            const alertId = 'alert-' + Date.now();
            
            let icon = 'info-circle';
            let alertClass = 'alert-info';
            
            switch(type) {
                case 'success':
                    icon = 'check-circle';
                    alertClass = 'alert-success';
                    break;
                case 'error':
                    icon = 'exclamation-circle';
                    alertClass = 'alert-error';
                    break;
                case 'warning':
                    icon = 'exclamation-triangle';
                    alertClass = 'alert-warning';
                    break;
                case 'info':
                    icon = 'info-circle';
                    alertClass = 'alert-info';
                    break;
            }
            
            const alertElement = document.createElement('div');
            alertElement.id = alertId;
            alertElement.className = `alert ${alertClass}`;
            alertElement.innerHTML = `
                <div class="alert-icon">
                    <i class="fas fa-${icon}"></i>
                </div>
                <div class="alert-content">
                    <div class="alert-title">${title}</div>
                    <div class="alert-message">${message}</div>
                </div>
                <button class="alert-close" onclick="closeAlert('${alertId}')">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            alertContainer.appendChild(alertElement);
            
            setTimeout(() => {
                alertElement.classList.add('show');
            }, 10);
            
            if (duration > 0) {
                setTimeout(() => {
                    closeAlert(alertId);
                }, duration);
            }
            
            return alertId;
        }
        
        function closeAlert(alertId) {
            const alertElement = document.getElementById(alertId);
            if (alertElement) {
                alertElement.classList.remove('show');
                setTimeout(() => {
                    if (alertElement.parentNode) {
                        alertElement.parentNode.removeChild(alertElement);
                    }
                }, 500);
            }
        }
        
        // ==================== CORE FUNCTIONS ====================
        
        function showLoading(message = 'กำลังโหลดข้อมูล...') {
            loadingOverlay.classList.remove('hidden');
            document.getElementById('loadingMessage').textContent = message;
        }
        
        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }
        
        function checkUserAndPermissions() {
            const savedUser = localStorage.getItem('inventoryUser');
            
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    showApp();
                    loadAllData();
                } catch (error) {
                    localStorage.removeItem('inventoryUser');
                    showLogin();
                    showAlert('error', 'ข้อผิดพลาด', 'เกิดข้อผิดพลาดในการโหลดข้อมูลผู้ใช้');
                }
            } else {
                showLogin();
            }
        }
        
        function showLogin() {
            loginPage.classList.remove('hidden');
            appContainer.classList.add('hidden');
        }
        
        function showApp() {
            loginPage.classList.add('hidden');
            appContainer.classList.remove('hidden');
            updateUserInfo();
            setupPermissions();
            showPage('dashboardPage');
        }
        
        function updateUserInfo() {
            if (!currentUser) return;
            
            const currentUsername = document.getElementById('currentUsername');
            const welcomeUsername = document.getElementById('welcomeUsername');
            const userRoleBadge = document.getElementById('userRoleBadge');
            
            if (currentUsername) currentUsername.textContent = currentUser.username;
            if (welcomeUsername) welcomeUsername.textContent = currentUser.username;
            
            let badgeClass = '';
            
            switch(currentUser.role) {
                case 'admin':
                    badgeClass = 'role-admin';
                    break;
                case 'manager':
                    badgeClass = 'role-manager';
                    break;
                case 'user':
                    badgeClass = 'role-user';
                    break;
            }
            
            if (userRoleBadge) {
                userRoleBadge.textContent = currentUser.role === 'admin' ? 'ผู้ดูแลระบบ' : 
                                          currentUser.role === 'manager' ? 'ผู้จัดการ' : 'ผู้ใช้ทั่วไป';
                userRoleBadge.className = `role-badge ${badgeClass}`;
            }
        }
        
        function setupPermissions() {
            if (!currentUser) return;
            
            const permissions = rolePermissions[currentUser.role];
            const navUsers = document.getElementById('navUsers');
            const navSalesReport = document.getElementById('navSalesReport');
            const navSettings = document.getElementById('navSettings');
            
            if (navUsers) navUsers.style.display = permissions.canManageUsers ? 'flex' : 'none';
            if (navSalesReport) navSalesReport.style.display = permissions.canViewSales ? 'flex' : 'none';
            if (navSettings) navSettings.style.display = permissions.canManageSettings ? 'flex' : 'none';
        }
        
        function checkPermission(permission) {
            if (!currentUser) return false;
            return rolePermissions[currentUser.role][permission] || false;
        }
        
        function showPage(pageId) {
            const pages = document.querySelectorAll('.page-content');
            pages.forEach(page => page.classList.add('hidden'));
            
            const activePage = document.getElementById(pageId);
            if (activePage) {
                activePage.classList.remove('hidden');
                
                if (pageId === 'salesPage') {
                    loadSalesProducts();
                    loadRecentSales();
                    updateTodaySalesStats();
                    resetCart();
                }
                
                if (pageId === 'salesReportPage') {
                    loadSalesReports();
                }
                
                if (pageId === 'dashboardPage') {
                    updateDashboardStats();
                    loadRecentSalesForDashboard();
                }
            }
            
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => link.classList.remove('active'));
            
            let navId = '';
            switch(pageId) {
                case 'dashboardPage': navId = 'navDashboard'; break;
                case 'productsPage': navId = 'navProducts'; break;
                case 'salesPage': navId = 'navSales'; break;
                case 'salesReportPage': navId = 'navSalesReport'; break;
                case 'usersPage': navId = 'navUsers'; break;
                case 'settingsPage': navId = 'navSettings'; break;
            }
            
            const activeNav = document.getElementById(navId);
            if (activeNav) {
                activeNav.classList.add('active');
            }
        }
        
        function loadAllData() {
            showLoading('กำลังโหลดข้อมูล...');
            
            Promise.all([
                loadProducts(),
                loadUsers(),
                loadSales(),
                loadSaleCounter()
            ]).then(() => {
                hideLoading();
                updateDashboardStats();
            }).catch(error => {
                hideLoading();
                showAlert('error', 'ข้อผิดพลาด', 'ไม่สามารถโหลดข้อมูลได้');
            });
        }
        
        function loadProducts() {
            return new Promise((resolve, reject) => {
                const productsRef = database.ref('products');
                
                productsRef.on('value', (snapshot) => {
                    products = [];
                    const data = snapshot.val();
                    
                    if (data) {
                        Object.keys(data).forEach(key => {
                            products.push({
                                id: key,
                                ...data[key]
                            });
                        });
                    }
                    
                    updateProductsTable();
                    resolve();
                }, (error) => {
                    reject(error);
                });
            });
        }
        
        function loadUsers() {
            return new Promise((resolve, reject) => {
                const usersRef = database.ref('users');
                
                usersRef.on('value', (snapshot) => {
                    users = [];
                    const data = snapshot.val();
                    
                    if (data) {
                        Object.keys(data).forEach(key => {
                            const userData = data[key];
                            if (userData && userData.username && userData.role) {
                                users.push({
                                    id: key,
                                    ...userData
                                });
                            }
                        });
                    }
                    
                    ensureDefaultUsers();
                    updateUsersTable();
                    resolve();
                }, (error) => {
                    reject(error);
                });
            });
        }
        
        function loadSales() {
            return new Promise((resolve, reject) => {
                const salesRef = database.ref('sales');
                
                salesRef.on('value', (snapshot) => {
                    sales = [];
                    const data = snapshot.val();
                    
                    if (data) {
                        Object.keys(data).forEach(key => {
                            sales.push({
                                id: key,
                                ...data[key]
                            });
                        });
                    }
                    
                    sales.sort((a, b) => new Date(b.saleDate) - new Date(a.saleDate));
                    resolve();
                }, (error) => {
                    reject(error);
                });
            });
        }
        
        function loadSaleCounter() {
            return new Promise((resolve) => {
                const counterRef = database.ref('saleCounter');
                
                counterRef.once('value').then(snapshot => {
                    const data = snapshot.val();
                    if (data && data.counter) {
                        saleCounter = data.counter;
                    } else {
                        saleCounter = 1;
                        counterRef.set({ counter: saleCounter });
                    }
                    resolve();
                }).catch(error => {
                    saleCounter = 1;
                    resolve();
                });
            });
        }
        
        function updateSaleCounter() {
            const counterRef = database.ref('saleCounter');
            counterRef.set({ counter: saleCounter });
        }
        
        // ตรวจสอบว่ามีผู้ใช้พื้นฐานในระบบหรือไม่ - แก้ไขแล้ว
        function ensureDefaultUsers() {
            const defaultUsers = [
                { 
                    username: 'admin', 
                    password: 'admin123', 
                    role: 'admin', 
                    fullName: 'ผู้ดูแลระบบ',
                    email: 'admin@example.com',
                    isActive: true
                },
                { 
                    username: 'manager', 
                    password: 'manager123', 
                    role: 'manager', 
                    fullName: 'ผู้จัดการ',
                    email: 'manager@example.com',
                    isActive: true
                },
                { 
                    username: 'user', 
                    password: 'user123', 
                    role: 'user', 
                    fullName: 'ผู้ใช้ทั่วไป',
                    email: 'user@example.com',
                    isActive: true
                }
            ];
            
            defaultUsers.forEach(defaultUser => {
                const userExists = users.some(user => user.username === defaultUser.username);
                if (!userExists) {
                    const safeId = defaultUser.username.replace(/[.#$[\]]/g, '_');
                    database.ref('users/' + safeId).set({
                        username: defaultUser.username,
                        password: defaultUser.password,
                        role: defaultUser.role,
                        fullName: defaultUser.fullName,
                        email: defaultUser.email,
                        createdAt: new Date().toISOString(),
                        lastLogin: null,
                        isActive: true,
                        createdBy: 'system'
                    }).then(() => {
                        console.log(`เพิ่มผู้ใช้พื้นฐาน: ${defaultUser.username}`);
                    }).catch(error => {
                        console.error(`Error adding default user ${defaultUser.username}:`, error);
                    });
                }
            });
        }
        
        function updateProductsTable() {
            const tableBody = document.getElementById('productsTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            if (products.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-6 py-12 text-center text-gray-500">
                            <i class="fas fa-box-open text-4xl mb-4"></i>
                            <p class="text-lg">ยังไม่มีข้อมูลสินค้า</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            const canDelete = checkPermission('canDelete');
            
            products.forEach(product => {
                const totalValue = product.quantity * product.price;
                const isLowStock = product.quantity <= 5 && product.quantity > 0;
                const isOutOfStock = product.quantity <= 0;
                
                let statusClass = 'bg-green-900 text-green-300';
                let statusText = 'พร้อมจำหน่าย';
                let statusIcon = 'check-circle';
                
                if (isLowStock) {
                    statusClass = 'bg-yellow-900 text-yellow-300';
                    statusText = 'เหลือน้อย';
                    statusIcon = 'exclamation-triangle';
                } else if (isOutOfStock) {
                    statusClass = 'bg-red-900 text-red-300';
                    statusText = 'หมดสต๊อก';
                    statusIcon = 'times-circle';
                }
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-700';
                
                let actionButtons = '';
                const canEdit = checkPermission('canEdit');
                
                if (canEdit) {
                    actionButtons += `
                        <button onclick="editProduct('${product.id}')" class="text-indigo-400 hover:text-indigo-300 mr-3">
                            <i class="fas fa-edit mr-1"></i> แก้ไข
                        </button>
                    `;
                }
                
                if (canDelete) {
                    actionButtons += `
                        <button onclick="showDeleteProductConfirm('${product.id}', '${product.productName}')" class="text-red-400 hover:text-red-300">
                            <i class="fas fa-trash-alt mr-1"></i> ลบ
                        </button>
                    `;
                }
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="font-mono font-bold text-indigo-300">${product.productCode}</span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="font-medium">${product.productName}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-3 py-1 bg-gray-700 rounded-full text-sm">${product.category}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="font-bold ${isOutOfStock ? 'text-red-400' : (isLowStock ? 'text-yellow-400' : 'text-green-400')}">${product.quantity}</span> ชิ้น
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ฿<span class="font-bold">${product.price}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="font-bold">฿${totalValue}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-3 py-1 rounded-full text-xs font-bold ${statusClass}">
                            <i class="fas fa-${statusIcon} mr-1"></i> ${statusText}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        ${actionButtons}
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        function updateUsersTable() {
            const tableBody = document.getElementById('usersTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            if (users.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                            <i class="fas fa-users text-4xl mb-4"></i>
                            <p class="text-lg">ยังไม่มีข้อมูลผู้ใช้</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            const canManageUsers = checkPermission('canManageUsers');
            
            users.forEach(user => {
                if (!user.username || !user.role) return;
                
                let roleBadge = '';
                let roleDisplay = '';
                
                switch(user.role) {
                    case 'admin':
                        roleBadge = 'role-admin';
                        roleDisplay = 'ผู้ดูแลระบบ';
                        break;
                    case 'manager':
                        roleBadge = 'role-manager';
                        roleDisplay = 'ผู้จัดการ';
                        break;
                    case 'user':
                        roleBadge = 'role-user';
                        roleDisplay = 'ผู้ใช้ทั่วไป';
                        break;
                }
                
                const status = user.isActive !== false ? 'active' : 'inactive';
                const statusText = user.isActive !== false ? 'ใช้งานได้' : 'ปิดใช้งาน';
                const statusColor = user.isActive !== false ? 'text-green-400' : 'text-red-400';
                
                const lastLogin = user.lastLogin ? new Date(user.lastLogin).toLocaleString('th-TH') : 'ไม่เคยล็อกอิน';
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-700';
                
                let actionButtons = '';
                
                if (canManageUsers) {
                    actionButtons = `
                        <button onclick="editUser('${user.id}')" class="text-indigo-400 hover:text-indigo-300 mr-3">
                            <i class="fas fa-edit mr-1"></i> แก้ไข
                        </button>
                    `;
                    
                    if (user.id !== currentUser.username) {
                        actionButtons += `
                            <button onclick="showDeleteUserConfirm('${user.id}', '${user.fullName || user.username}')" class="text-red-400 hover:text-red-300">
                                <i class="fas fa-trash-alt mr-1"></i> ลบ
                            </button>
                        `;
                    }
                }
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="font-medium">${user.username}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="font-medium">${user.fullName || '-'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="${roleBadge}">${roleDisplay}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="${statusColor} font-medium">${statusText}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        ${lastLogin}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        ${actionButtons}
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        function updateDashboardStats() {
            const totalProducts = products.length;
            const totalValue = products.reduce((sum, product) => sum + (product.quantity * product.price), 0);
            const outOfStock = products.filter(p => p.quantity <= 0).length;
            
            document.getElementById('totalProducts').textContent = totalProducts;
            document.getElementById('totalValue').textContent = '฿' + totalValue;
            document.getElementById('outOfStock').textContent = outOfStock;
            
            const today = new Date().toISOString().split('T')[0];
            const todaySales = sales.filter(sale => {
                const saleDate = new Date(sale.saleDate).toISOString().split('T')[0];
                return saleDate === today;
            });
            
            const todayTotal = todaySales.reduce((sum, sale) => sum + sale.totalAmount, 0);
            document.getElementById('todaySales').textContent = '฿' + todayTotal;
        }
        
        function loadRecentSalesForDashboard() {
            const recentSalesContainer = document.getElementById('recentSales');
            if (!recentSalesContainer) return;
            
            recentSalesContainer.innerHTML = '';
            
            const recentSales = sales.slice(0, 5);
            
            if (recentSales.length === 0) {
                recentSalesContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-receipt text-2xl mb-2"></i>
                        <p>ยังไม่มีข้อมูลการขายล่าสุด</p>
                    </div>
                `;
                return;
            }
            
            recentSales.forEach(sale => {
                const saleElement = document.createElement('div');
                saleElement.className = 'bg-gray-900/50 p-4 rounded-lg';
                
                const saleDate = new Date(sale.saleDate);
                const formattedDate = saleDate.toLocaleDateString('th-TH', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric'
                });
                
                saleElement.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-medium">${sale.customerName}</div>
                            <div class="text-gray-400 text-sm">${formattedDate}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-lg text-green-400">฿${sale.totalAmount}</div>
                            <div class="text-gray-400 text-sm">${sale.saleCode}</div>
                        </div>
                    </div>
                `;
                
                recentSalesContainer.appendChild(saleElement);
            });
        }
        
        // ==================== SALES SYSTEM FUNCTIONS ====================
        
        function loadSalesProducts() {
            const productList = document.getElementById('salesProductList');
            if (!productList) return;
            
            productList.innerHTML = '';
            
            if (products.length === 0) {
                productList.innerHTML = `
                    <div class="col-span-2 text-center py-12 text-gray-500">
                        <i class="fas fa-box-open text-3xl mb-3"></i>
                        <p>ยังไม่มีข้อมูลสินค้า</p>
                    </div>
                `;
                return;
            }
            
            const inStockProducts = products.filter(p => p.quantity > 0);
            
            if (inStockProducts.length === 0) {
                productList.innerHTML = `
                    <div class="col-span-2 text-center py-12 text-gray-500">
                        <i class="fas fa-exclamation-triangle text-3xl mb-3"></i>
                        <p>สินค้าหมดสต๊อกทั้งหมด</p>
                    </div>
                `;
                return;
            }
            
            inStockProducts.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'bg-gray-900 rounded-lg p-4';
                
                const isLowStock = product.quantity <= 5;
                
                productCard.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h4 class="font-bold">${product.productName}</h4>
                            <div class="flex items-center mt-1">
                                <span class="text-xs px-2 py-1 bg-gray-700 rounded">${product.category}</span>
                            </div>
                        </div>
                        <span class="font-bold text-green-400">฿${product.price}</span>
                    </div>
                    
                    <div class="flex justify-between items-center mt-4">
                        <div>
                            <span class="text-sm ${isLowStock ? 'text-yellow-400' : 'text-gray-300'}">
                                <i class="fas fa-box mr-1"></i> คงเหลือ: ${product.quantity} ชิ้น
                            </span>
                        </div>
                        <button onclick="addToCart('${product.id}')" class="px-3 py-1 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 rounded text-sm">
                            <i class="fas fa-plus mr-1"></i> เพิ่ม
                        </button>
                    </div>
                `;
                
                productList.appendChild(productCard);
            });
        }
        
        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            const existingItem = cart.find(item => item.id === productId);
            
            if (existingItem) {
                if (existingItem.quantity < product.quantity) {
                    existingItem.quantity += 1;
                    existingItem.total = existingItem.quantity * existingItem.price;
                } else {
                    showAlert('warning', 'สินค้าไม่เพียงพอ', `สินค้า ${product.productName} เหลือเพียง ${product.quantity} ชิ้น`);
                    return;
                }
            } else {
                if (product.quantity > 0) {
                    cart.push({
                        id: productId,
                        productCode: product.productCode,
                        productName: product.productName,
                        price: product.price,
                        quantity: 1,
                        total: product.price
                    });
                } else {
                    showAlert('warning', 'สินค้าหมดสต๊อก', `สินค้า ${product.productName} หมดสต๊อก`);
                    return;
                }
            }
            
            updateCartDisplay();
        }
        
        function updateCartDisplay() {
            const cartItems = document.getElementById('cartItems');
            const cartSubtotal = document.getElementById('cartSubtotal');
            const cartTotal = document.getElementById('cartTotal');
            const discountAmount = document.getElementById('discountAmount');
            
            if (!cartItems || !cartSubtotal || !cartTotal) return;
            
            cartItems.innerHTML = '';
            
            if (cart.length === 0) {
                cartItems.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-shopping-cart text-2xl mb-2"></i>
                        <p>ยังไม่มีสินค้าในตะกร้า</p>
                    </div>
                `;
                
                cartSubtotal.textContent = '฿0.00';
                cartTotal.textContent = '฿0.00';
                return;
            }
            
            cart.forEach((item, index) => {
                const cartItem = document.createElement('div');
                cartItem.className = 'flex justify-between items-center p-3 bg-gray-800 rounded';
                
                cartItem.innerHTML = `
                    <div class="flex-1">
                        <div class="font-medium">${item.productName}</div>
                        <div class="text-green-400 font-bold">฿${item.price}</div>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <button onclick="decreaseQuantity(${index})" class="w-8 h-8 flex items-center justify-center bg-gray-700 hover:bg-gray-600 rounded">
                            <i class="fas fa-minus"></i>
                        </button>
                        
                        <span class="w-12 text-center font-bold">${item.quantity}</span>
                        
                        <button onclick="increaseQuantity(${index})" class="w-8 h-8 flex items-center justify-center bg-gray-700 hover:bg-gray-600 rounded">
                            <i class="fas fa-plus"></i>
                        </button>
                        
                        <span class="w-24 text-right font-bold">฿${item.total}</span>
                        
                        <button onclick="removeFromCart(${index})" class="w-8 h-8 flex items-center justify-center bg-red-700 hover:bg-red-600 rounded ml-2">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                cartItems.appendChild(cartItem);
            });
            
            const subtotal = cart.reduce((sum, item) => sum + item.total, 0);
            const discount = parseFloat(discountAmount.value) || 0;
            const total = subtotal - discount;
            
            cartSubtotal.textContent = '฿' + subtotal;
            cartTotal.textContent = '฿' + (total > 0 ? total : 0);
        }
        
        function increaseQuantity(index) {
            if (index < 0 || index >= cart.length) return;
            
            const item = cart[index];
            const product = products.find(p => p.id === item.id);
            
            if (!product) return;
            
            if (item.quantity < product.quantity) {
                item.quantity += 1;
                item.total = item.quantity * item.price;
                updateCartDisplay();
            } else {
                showAlert('warning', 'สินค้าไม่เพียงพอ', `สินค้า ${product.productName} เหลือเพียง ${product.quantity} ชิ้น`);
            }
        }
        
        function decreaseQuantity(index) {
            if (index < 0 || index >= cart.length) return;
            
            const item = cart[index];
            
            if (item.quantity > 1) {
                item.quantity -= 1;
                item.total = item.quantity * item.price;
                updateCartDisplay();
            } else {
                removeFromCart(index);
            }
        }
        
        function removeFromCart(index) {
            if (index < 0 || index >= cart.length) return;
            
            cart.splice(index, 1);
            updateCartDisplay();
        }
        
        function resetCart() {
            cart = [];
            document.getElementById('customerName').value = 'ลูกค้าทั่วไป';
            document.getElementById('paymentMethod').value = 'เงินสด';
            document.getElementById('discountAmount').value = '0';
            updateCartDisplay();
        }
        
        function completeSale() {
            if (cart.length === 0) {
                showAlert('error', 'ตะกร้าว่าง', 'กรุณาเพิ่มสินค้าลงในตะกร้าก่อนบันทึกการขาย');
                return;
            }
            
            const customerName = document.getElementById('customerName').value.trim() || 'ลูกค้าทั่วไป';
            const paymentMethod = document.getElementById('paymentMethod').value;
            const discount = parseFloat(document.getElementById('discountAmount').value) || 0;
            
            const subtotal = cart.reduce((sum, item) => sum + item.total, 0);
            const totalAmount = subtotal - discount;
            
            if (totalAmount <= 0) {
                showAlert('error', 'ยอดขายไม่ถูกต้อง', 'ยอดขายรวมต้องมากกว่า 0 บาท');
                return;
            }
            
            for (const item of cart) {
                const product = products.find(p => p.id === item.id);
                if (!product || product.quantity < item.quantity) {
                    showAlert('error', 'สินค้าไม่เพียงพอ', `สินค้า ${item.productName} มีเพียง ${product ? product.quantity : 0} ชิ้น`);
                    return;
                }
            }
            
            processSale(customerName, paymentMethod, discount, totalAmount);
        }
        
        function processSale(customerName, paymentMethod, discount, totalAmount) {
            showLoading('กำลังบันทึกการขาย...');
            
            const saleCode = `S${String(saleCounter).padStart(3, '0')}`;
            saleCounter++;
            
            const saleData = {
                saleCode: saleCode,
                customerName: customerName,
                paymentMethod: paymentMethod,
                discount: discount,
                subtotal: cart.reduce((sum, item) => sum + item.total, 0),
                totalAmount: totalAmount,
                saleDate: new Date().toISOString(),
                seller: currentUser.username,
                items: {}
            };
            
            cart.forEach((item, index) => {
                saleData.items[`item${index}`] = {
                    productId: item.id,
                    productCode: item.productCode,
                    productName: item.productName,
                    price: item.price,
                    quantity: item.quantity,
                    total: item.total
                };
            });
            
            database.ref('sales').push(saleData)
                .then((ref) => {
                    const saleId = ref.key;
                    
                    updateSaleCounter();
                    
                    const updatePromises = cart.map(item => {
                        const productRef = database.ref('products/' + item.id);
                        return productRef.once('value').then(snapshot => {
                            const product = snapshot.val();
                            const newQuantity = product.quantity - item.quantity;
                            
                            return productRef.update({
                                quantity: newQuantity,
                                updatedBy: currentUser.username,
                                updatedAt: new Date().toISOString()
                            });
                        });
                    });
                    
                    return Promise.all(updatePromises);
                })
                .then(() => {
                    hideLoading();
                    
                    showReceipt(saleData);
                    
                    resetCart();
                    
                    loadProducts();
                    loadSales();
                    updateTodaySalesStats();
                    loadRecentSales();
                    
                    showAlert('success', 'ขายสำเร็จ', `บันทึกการขาย ${saleCode} เรียบร้อยแล้ว`);
                })
                .catch(error => {
                    hideLoading();
                    showAlert('error', 'ข้อผิดพลาด', 'เกิดข้อผิดพลาดในการบันทึกการขาย');
                });
        }
        
        function showReceipt(saleData) {
            const modal = document.getElementById('receiptModal');
            const receiptNumber = document.getElementById('receiptNumber');
            const receiptDate = document.getElementById('receiptDate');
            const receiptCustomer = document.getElementById('receiptCustomer');
            const receiptItems = document.getElementById('receiptItems');
            const receiptSubtotal = document.getElementById('receiptSubtotal');
            const receiptDiscount = document.getElementById('receiptDiscount');
            const receiptTotal = document.getElementById('receiptTotal');
            const receiptPaymentMethod = document.getElementById('receiptPaymentMethod');
            
            receiptNumber.textContent = saleData.saleCode;
            receiptDate.textContent = new Date(saleData.saleDate).toLocaleString('th-TH');
            receiptCustomer.textContent = saleData.customerName;
            receiptSubtotal.textContent = '฿' + saleData.subtotal;
            receiptDiscount.textContent = '฿' + saleData.discount;
            receiptTotal.textContent = '฿' + saleData.totalAmount;
            receiptPaymentMethod.textContent = saleData.paymentMethod;
            
            receiptItems.innerHTML = '';
            
            Object.values(saleData.items).forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'flex justify-between mb-1';
                itemElement.innerHTML = `
                    <span>${item.productName} x${item.quantity}</span>
                    <span>฿${item.total}</span>
                `;
                receiptItems.appendChild(itemElement);
            });
            
            modal.classList.remove('hidden');
        }
        
        // ฟังก์ชันสำหรับดึงข้อมูลใบเสร็จจาก Firebase - NEW
        function loadReceiptData(saleId) {
            return new Promise((resolve, reject) => {
                const saleRef = database.ref('sales/' + saleId);
                
                saleRef.once('value').then(snapshot => {
                    const saleData = snapshot.val();
                    if (saleData) {
                        resolve({
                            id: saleId,
                            ...saleData
                        });
                    } else {
                        reject(new Error('ไม่พบข้อมูลใบเสร็จ'));
                    }
                }).catch(error => {
                    reject(error);
                });
            });
        }
        
        // แก้ไขฟังก์ชัน viewReceipt ให้ใช้งานได้ - FIXED
        function viewReceipt(saleId) {
            showLoading('กำลังโหลดข้อมูลใบเสร็จ...');
            
            loadReceiptData(saleId)
                .then(sale => {
                    hideLoading();
                    showReceipt(sale);
                })
                .catch(error => {
                    hideLoading();
                    showAlert('error', 'ไม่พบข้อมูล', 'ไม่พบข้อมูลใบเสร็จที่ต้องการ');
                });
        }
        
        function loadRecentSales() {
            const recentSalesList = document.getElementById('recentSalesList');
            if (!recentSalesList) return;
            
            recentSalesList.innerHTML = '';
            
            const recentSales = sales.slice(0, 5);
            
            if (recentSales.length === 0) {
                recentSalesList.innerHTML = `
                    <div class="text-center py-4 text-gray-500">
                        <i class="fas fa-receipt text-xl mb-2"></i>
                        <p class="text-sm">ยังไม่มีการขายล่าสุด</p>
                    </div>
                `;
                return;
            }
            
            recentSales.forEach(sale => {
                const saleElement = document.createElement('div');
                saleElement.className = 'bg-gray-900/50 p-3 rounded-lg';
                
                const saleDate = new Date(sale.saleDate);
                const formattedTime = saleDate.toLocaleTimeString('th-TH', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                saleElement.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-medium text-sm">${sale.customerName}</div>
                            <div class="text-gray-400 text-xs">${formattedTime}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-green-400">฿${sale.totalAmount}</div>
                            <div class="text-gray-400 text-xs">${sale.saleCode}</div>
                        </div>
                    </div>
                `;
                
                recentSalesList.appendChild(saleElement);
            });
        }
        
        function updateTodaySalesStats() {
            const today = new Date().toISOString().split('T')[0];
            const todaySales = sales.filter(sale => {
                const saleDate = new Date(sale.saleDate).toISOString().split('T')[0];
                return saleDate === today;
            });
            
            const todaySalesCount = document.getElementById('todaySalesCount');
            const todaySalesTotal = document.getElementById('todaySalesTotal');
            
            if (todaySalesCount) todaySalesCount.textContent = todaySales.length;
            
            const totalAmount = todaySales.reduce((sum, sale) => sum + sale.totalAmount, 0);
            if (todaySalesTotal) todaySalesTotal.textContent = '฿' + totalAmount;
        }
        
        // ==================== PRODUCT MANAGEMENT ====================
        
        function showProductModal(product = null) {
            const modal = document.getElementById('productModal');
            const modalTitle = document.getElementById('modalProductTitle');
            const productId = document.getElementById('productId');
            const productCode = document.getElementById('productCode');
            const productName = document.getElementById('productName');
            const productCategory = document.getElementById('productCategory');
            const productQuantity = document.getElementById('productQuantity');
            const productPrice = document.getElementById('productPrice');
            
            if (product) {
                modalTitle.textContent = 'แก้ไขข้อมูลสินค้า';
                productId.value = product.id;
                productCode.value = product.productCode;
                productName.value = product.productName;
                productCategory.value = product.category;
                productQuantity.value = product.quantity;
                productPrice.value = product.price;
            } else {
                modalTitle.textContent = 'เพิ่มสินค้าใหม่';
                productId.value = '';
                productCode.value = '';
                productName.value = '';
                productCategory.value = '';
                productQuantity.value = '';
                productPrice.value = '';
            }
            
            modal.classList.remove('hidden');
        }
        
        function hideProductModal() {
            document.getElementById('productModal').classList.add('hidden');
        }
        
        function saveProduct(e) {
            e.preventDefault();
            
            const productId = document.getElementById('productId').value;
            const productCode = document.getElementById('productCode').value.trim();
            const productName = document.getElementById('productName').value.trim();
            const category = document.getElementById('productCategory').value;
            const quantity = parseInt(document.getElementById('productQuantity').value);
            const price = parseFloat(document.getElementById('productPrice').value);
            
            if (!productCode || !productName || !category || isNaN(quantity) || isNaN(price)) {
                showAlert('error', 'ข้อมูลไม่ครบถ้วน', 'กรุณากรอกข้อมูลให้ครบถ้วนและถูกต้อง');
                return;
            }
            
            const productData = {
                productCode,
                productName,
                category,
                quantity,
                price,
                updatedBy: currentUser.username,
                updatedAt: new Date().toISOString()
            };
            
            if (productId) {
                database.ref('products/' + productId).update(productData)
                    .then(() => {
                        hideProductModal();
                        showAlert('success', 'อัพเดทสำเร็จ', 'อัพเดทข้อมูลสินค้าเรียบร้อยแล้ว');
                    })
                    .catch(error => {
                        showAlert('error', 'ข้อผิดพลาด', 'เกิดข้อผิดพลาดในการอัพเดทข้อมูล');
                    });
            } else {
                const isDuplicate = products.some(product => product.productCode === productCode);
                if (isDuplicate) {
                    showAlert('error', 'ข้อมูลซ้ำ', 'รหัสสินค้านี้มีอยู่ในระบบแล้ว กรุณาใช้รหัสอื่น');
                    return;
                }
                
                productData.createdBy = currentUser.username;
                productData.createdAt = new Date().toISOString();
                
                database.ref('products').push(productData)
                    .then(() => {
                        hideProductModal();
                        showAlert('success', 'เพิ่มสำเร็จ', 'เพิ่มข้อมูลสินค้าใหม่เรียบร้อยแล้ว');
                    })
                    .catch(error => {
                        showAlert('error', 'ข้อผิดพลาด', 'เกิดข้อผิดพลาดในการเพิ่มข้อมูล');
                    });
            }
        }
        
        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (product) {
                showProductModal(product);
            }
        }
        
        function showDeleteProductConfirm(productId, productName) {
            if (!checkPermission('canDelete')) {
                showAlert('error', 'ไม่มีสิทธิ์', 'ขออภัย คุณไม่มีสิทธิ์ลบข้อมูลสินค้า');
                return;
            }
            
            productToDelete = productId;
            
            showConfirmation(
                'ยืนยันการลบข้อมูลสินค้า',
                `คุณแน่ใจหรือไม่ว่าต้องการลบสินค้า "${productName}"?`,
                'warning',
                'ลบข้อมูล',
                'ยกเลิก'
            ).then(confirmed => {
                if (confirmed) {
                    deleteProduct();
                } else {
                    productToDelete = null;
                }
            });
        }
        
        function deleteProduct() {
            if (!productToDelete || !checkPermission('canDelete')) {
                showAlert('error', 'ไม่มีสิทธิ์', 'คุณไม่มีสิทธิ์ลบข้อมูลสินค้า');
                return;
            }
            
            showLoading('กำลังลบข้อมูลสินค้า...');
            
            database.ref('products/' + productToDelete).remove()
                .then(() => {
                    hideLoading();
                    showAlert('success', 'ลบสำเร็จ', 'ลบข้อมูลสินค้าเรียบร้อยแล้ว');
                    productToDelete = null;
                })
                .catch(error => {
                    hideLoading();
                    showAlert('error', 'ข้อผิดพลาด', 'เกิดข้อผิดพลาดในการลบข้อมูล');
                    productToDelete = null;
                });
        }
        
        // ==================== USER MANAGEMENT ====================
        
        function showUserModal(user = null) {
            if (!checkPermission('canManageUsers')) {
                showAlert('error', 'ไม่มีสิทธิ์', 'ขออภัย คุณไม่มีสิทธิ์จัดการผู้ใช้');
                return;
            }
            
            const modal = document.getElementById('userModal');
            const modalTitle = document.getElementById('modalUserTitle');
            const userId = document.getElementById('userId');
            const newUsername = document.getElementById('newUsername');
            const newPassword = document.getElementById('newPassword');
            const fullName = document.getElementById('fullName');
            const userRole = document.getElementById('userRole');
            
            if (user) {
                modalTitle.textContent = 'แก้ไขข้อมูลผู้ใช้';
                userId.value = user.id;
                newUsername.value = user.username;
                newUsername.disabled = true;
                newPassword.required = false;
                newPassword.placeholder = 'เว้นว่างหากไม่ต้องการเปลี่ยนรหัสผ่าน';
                fullName.value = user.fullName || '';
                userRole.value = user.role || 'user';
            } else {
                modalTitle.textContent = 'เพิ่มผู้ใช้ใหม่';
                userId.value = '';
                newUsername.value = '';
                newUsername.disabled = false;
                newPassword.required = true;
                newPassword.placeholder = 'กรอกรหัสผ่าน';
                fullName.value = '';
                userRole.value = 'user';
            }
            
            modal.classList.remove('hidden');
        }
        
        function hideUserModal() {
            document.getElementById('userModal').classList.add('hidden');
        }
        
        // แก้ไขฟังก์ชัน saveUser ให้ทำงานได้สมบูรณ์ - FIXED
        function saveUser(e) {
            e.preventDefault();
            
            if (!checkPermission('canManageUsers')) {
                showAlert('error', 'ไม่มีสิทธิ์', 'ขออภัย คุณไม่มีสิทธิ์จัดการผู้ใช้');
                return;
            }
            
            const userId = document.getElementById('userId').value;
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value;
            const fullName = document.getElementById('fullName').value.trim();
            const role = document.getElementById('userRole').value;
            
            if (!username || !role) {
                showAlert('error', 'ข้อมูลไม่ครบถ้วน', 'กรุณากรอกชื่อผู้ใช้และบทบาท');
                return;
            }
            
            if (!userId && !password) {
                showAlert('error', 'ข้อมูลไม่ครบถ้วน', 'กรุณากรอกรหัสผ่านสำหรับผู้ใช้ใหม่');
                return;
            }
            
            const userData = {
                username: username,
                fullName: fullName,
                role: role,
                updatedBy: currentUser.username,
                updatedAt: new Date().toISOString(),
                isActive: true,
                email: username + '@example.com'
            };
            
            if (password) {
                userData.password = password;
            }
            
            showLoading('กำลังบันทึกข้อมูลผู้ใช้...');
            
            if (userId) {
                database.ref('users/' + userId).update(userData)
                    .then(() => {
                        hideLoading();
                        hideUserModal();
                        loadUsers();
                        showAlert('success', 'อัพเดทสำเร็จ', 'อัพเดทข้อมูลผู้ใช้เรียบร้อยแล้ว');
                    })
                    .catch(error => {
                        hideLoading();
                        showAlert('error', 'ข้อผิดพลาด', 'เกิดข้อผิดพลาดในการอัพเดทข้อมูลผู้ใช้');
                    });
            } else {
                const isDuplicate = users.some(user => user.username === username);
                if (isDuplicate) {
                    hideLoading();
                    showAlert('error', 'ข้อมูลซ้ำ', 'ชื่อผู้ใช้นี้มีอยู่ในระบบแล้ว กรุณาใช้ชื่ออื่น');
                    return;
                }
                
                userData.createdAt = new Date().toISOString();
                userData.createdBy = currentUser.username;
                userData.password = password;
                
                const newUserId = username.replace(/[.#$[\]]/g, '_');
                
                database.ref('users/' + newUserId).set(userData)
                    .then(() => {
                        hideLoading();
                        hideUserModal();
                        loadUsers();
                        showAlert('success', 'เพิ่มสำเร็จ', 'เพิ่มผู้ใช้ใหม่เรียบร้อยแล้ว');
                    })
                    .catch(error => {
                        hideLoading();
                        showAlert('error', 'ข้อผิดพลาด', 'เกิดข้อผิดพลาดในการเพิ่มผู้ใช้');
                    });
            }
        }
        
        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (user) {
                showUserModal(user);
            }
        }
        
        function showDeleteUserConfirm(userId, userName) {
            if (!checkPermission('canManageUsers')) {
                showAlert('error', 'ไม่มีสิทธิ์', 'ขออภัย คุณไม่มีสิทธิ์จัดการผู้ใช้');
                return;
            }
            
            if (userId === currentUser.username) {
                showAlert('error', 'ไม่สามารถดำเนินการได้', 'ไม่สามารถลบบัญชีผู้ใช้ปัจจุบันได้');
                return;
            }
            
            userToDelete = userId;
            
            showConfirmation(
                'ยืนยันการลบข้อมูลผู้ใช้',
                `คุณแน่ใจหรือไม่ว่าต้องการลบผู้ใช้ "${userName}"?`,
                'warning',
                'ลบข้อมูล',
                'ยกเลิก'
            ).then(confirmed => {
                if (confirmed) {
                    deleteUser();
                } else {
                    userToDelete = null;
                }
            });
        }
        
        // แก้ไขฟังก์ชัน deleteUser ให้ทำงานได้สมบูรณ์ - FIXED
        function deleteUser() {
            if (!userToDelete || !checkPermission('canManageUsers')) {
                showAlert('error', 'ไม่มีสิทธิ์', 'คุณไม่มีสิทธิ์ลบข้อมูลผู้ใช้');
                return;
            }
            
            showLoading('กำลังลบข้อมูลผู้ใช้...');
            
            const safeUserId = userToDelete.replace(/[.#$[\]]/g, '_');
            
            database.ref('users/' + safeUserId).remove()
                .then(() => {
                    hideLoading();
                    showAlert('success', 'ลบสำเร็จ', 'ลบข้อมูลผู้ใช้เรียบร้อยแล้ว');
                    userToDelete = null;
                    loadUsers();
                })
                .catch(error => {
                    hideLoading();
                    showAlert('error', 'ข้อผิดพลาด', 'เกิดข้อผิดพลาดในการลบข้อมูลผู้ใช้');
                    userToDelete = null;
                });
        }
        
        // ==================== SALES REPORT FUNCTIONS ====================
        
        function loadSalesReports() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 7);
            
            document.getElementById('reportStartDate').valueAsDate = startDate;
            document.getElementById('reportEndDate').valueAsDate = endDate;
            
            setupReportTabs();
            generateSalesReport();
        }
        
        function setupReportTabs() {
            const tabs = document.querySelectorAll('.tab[data-tab]');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                    document.getElementById(tabId).classList.remove('hidden');
                });
            });
        }
        
        function generateSalesReport() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            if (!startDate || !endDate) {
                showAlert('error', 'ข้อมูลไม่ครบถ้วน', 'กรุณาเลือกวันที่เริ่มต้นและสิ้นสุด');
                return;
            }
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            end.setHours(23, 59, 59, 999);
            
            let filteredSales = sales.filter(sale => {
                const saleDate = new Date(sale.saleDate);
                return saleDate >= start && saleDate <= end;
            });
            
            updateReportStatistics(filteredSales);
            updateDailyReport(filteredSales);
            updateSalesListReport(filteredSales);
        }
        
        function updateReportStatistics(filteredSales) {
            const totalSalesCount = filteredSales.length;
            const totalSalesAmount = filteredSales.reduce((sum, sale) => sum + sale.totalAmount, 0);
            const totalItemsSold = filteredSales.reduce((sum, sale) => {
                return sum + (sale.items ? Object.keys(sale.items).length : 0);
            }, 0);
            const averageSaleAmount = totalSalesCount > 0 ? totalSalesAmount / totalSalesCount : 0;
            
            document.getElementById('totalSalesCount').textContent = totalSalesCount;
            document.getElementById('totalSalesAmount').textContent = '฿' + totalSalesAmount;
            document.getElementById('totalItemsSold').textContent = totalItemsSold;
            document.getElementById('averageSaleAmount').textContent = '฿' + averageSaleAmount;
        }
        
        function updateDailyReport(filteredSales = []) {
            if (filteredSales.length === 0) {
                const startDate = document.getElementById('reportStartDate').value;
                const endDate = document.getElementById('reportEndDate').value;
                
                if (!startDate || !endDate) return;
                
                const start = new Date(startDate);
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999);
                
                filteredSales = sales.filter(sale => {
                    const saleDate = new Date(sale.saleDate);
                    return saleDate >= start && saleDate <= end;
                });
            }
            
            const dailySales = {};
            
            filteredSales.forEach(sale => {
                const saleDate = new Date(sale.saleDate);
                const dateKey = saleDate.toISOString().split('T')[0];
                
                if (!dailySales[dateKey]) {
                    dailySales[dateKey] = {
                        date: saleDate,
                        salesCount: 0,
                        totalAmount: 0,
                        itemsSold: 0
                    };
                }
                
                dailySales[dateKey].salesCount++;
                dailySales[dateKey].totalAmount += sale.totalAmount;
                dailySales[dateKey].itemsSold += sale.items ? Object.keys(sale.items).length : 0;
            });
            
            const dailyArray = Object.values(dailySales).sort((a, b) => a.date - b.date);
            
            const tableBody = document.getElementById('dailySalesTableBody');
            tableBody.innerHTML = '';
            
            if (dailyArray.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                            <i class="fas fa-chart-line text-xl mb-2"></i>
                            <p>ไม่มีข้อมูลการขายในช่วงเวลาที่เลือก</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            dailyArray.forEach(day => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-700';
                row.innerHTML = `
                    <td class="px-4 py-3">${day.date.toLocaleDateString('th-TH')}</td>
                    <td class="px-4 py-3">${day.salesCount}</td>
                    <td class="px-4 py-3">฿${day.totalAmount}</td>
                    <td class="px-4 py-3">${day.itemsSold}</td>
                    <td class="px-4 py-3">฿${(day.totalAmount / day.salesCount)}</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function updateSalesListReport(filteredSales = []) {
            if (filteredSales.length === 0) {
                const startDate = document.getElementById('reportStartDate').value;
                const endDate = document.getElementById('reportEndDate').value;
                
                if (!startDate || !endDate) return;
                
                const start = new Date(startDate);
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999);
                
                filteredSales = sales.filter(sale => {
                    const saleDate = new Date(sale.saleDate);
                    return saleDate >= start && saleDate <= end;
                });
            }
            
            const tableBody = document.getElementById('salesListTableBody');
            tableBody.innerHTML = '';
            
            if (filteredSales.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                            <i class="fas fa-receipt text-xl mb-2"></i>
                            <p>ไม่มีข้อมูลการขายในช่วงเวลาที่เลือก</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredSales.forEach(sale => {
                const saleDate = new Date(sale.saleDate);
                const formattedDate = saleDate.toLocaleDateString('th-TH', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric'
                });
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-700';
                row.innerHTML = `
                    <td class="px-4 py-3">${sale.saleCode}</td>
                    <td class="px-4 py-3">${sale.customerName}</td>
                    <td class="px-4 py-3">${formattedDate}</td>
                    <td class="px-4 py-3">${sale.items ? Object.keys(sale.items).length : 0}</td>
                    <td class="px-4 py-3">฿${sale.totalAmount}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 bg-gray-700 rounded text-xs">${sale.paymentMethod}</span>
                    </td>
                    <td class="px-4 py-3">${sale.seller}</td>
                    <td class="px-4 py-3">
                        <button onclick="viewReceipt('${sale.id}')" class="text-indigo-400 hover:text-indigo-300">
                            <i class="fas fa-receipt mr-1"></i> ดูใบเสร็จ
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // ==================== UTILITY FUNCTIONS ====================
        
        function showConfirmation(title, message, icon = 'warning', confirmText = 'ยืนยัน', cancelText = 'ยกเลิก') {
            return new Promise((resolve) => {
                const dialog = document.getElementById('confirmationDialog');
                const dialogIcon = document.getElementById('confirmationIcon');
                const dialogTitle = document.getElementById('confirmationTitle');
                const dialogMessage = document.getElementById('confirmationMessage');
                const confirmBtn = document.getElementById('confirmActionBtn');
                const cancelBtn = document.getElementById('cancelConfirmBtn');
                
                dialogTitle.textContent = title;
                dialogMessage.textContent = message;
                confirmBtn.textContent = confirmText;
                cancelBtn.textContent = cancelText;
                
                let iconClass = 'exclamation-triangle text-yellow-500';
                switch(icon) {
                    case 'success':
                        iconClass = 'check-circle text-green-500';
                        break;
                    case 'error':
                        iconClass = 'times-circle text-red-500';
                        break;
                    case 'question':
                        iconClass = 'question-circle text-purple-500';
                        break;
                }
                dialogIcon.innerHTML = `<i class="fas ${iconClass}"></i>`;
                
                dialog.classList.remove('hidden');
                setTimeout(() => {
                    dialog.classList.add('show');
                }, 10);
                
                const handleConfirm = () => {
                    cleanup();
                    resolve(true);
                };
                
                const handleCancel = () => {
                    cleanup();
                    resolve(false);
                };
                
                const cleanup = () => {
                    dialog.classList.remove('show');
                    setTimeout(() => {
                        dialog.classList.add('hidden');
                    }, 300);
                    confirmBtn.removeEventListener('click', handleConfirm);
                    cancelBtn.removeEventListener('click', handleCancel);
                };
                
                confirmBtn.addEventListener('click', handleConfirm);
                cancelBtn.addEventListener('click', handleCancel);
            });
        }
        
        function loginUser(username, password) {
            showLoading('กำลังตรวจสอบข้อมูลผู้ใช้...');
            
            database.ref('users/' + username).once('value').then(snapshot => {
                const userData = snapshot.val();
                
                if (userData && userData.password === password) {
                    currentUser = {
                        username: username,
                        role: userData.role || 'user',
                        fullName: userData.fullName || username
                    };
                    
                    localStorage.setItem('inventoryUser', JSON.stringify(currentUser));
                    
                    database.ref('users/' + username).update({
                        lastLogin: new Date().toISOString()
                    });
                    
                    setTimeout(() => {
                        hideLoading();
                        showApp();
                        showAlert('success', 'ล็อกอินสำเร็จ', `ยินดีต้อนรับ ${username}!`);
                    }, 1000);
                    
                } else {
                    hideLoading();
                    showAlert('error', 'ล็อกอินไม่สำเร็จ', 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง');
                }
            }).catch(error => {
                hideLoading();
                showAlert('error', 'ข้อผิดพลาด', 'เกิดข้อผิดพลาดในการตรวจสอบข้อมูลผู้ใช้');
            });
        }
        
        function logout() {
            showConfirmation(
                'ออกจากระบบ',
                'คุณแน่ใจหรือไม่ว่าต้องการออกจากระบบ?',
                'question',
                'ออกจากระบบ',
                'ยกเลิก'
            ).then(confirmed => {
                if (confirmed) {
                    localStorage.removeItem('inventoryUser');
                    currentUser = null;
                    products = [];
                    users = [];
                    sales = [];
                    cart = [];
                    showLogin();
                    showAlert('success', 'ออกจากระบบสำเร็จ', 'คุณได้ออกจากระบบเรียบร้อยแล้ว');
                }
            });
        }
        
        function exportProducts() {
            if (products.length === 0) {
                showAlert('warning', 'ไม่มีข้อมูล', 'ไม่มีข้อมูลสินค้าให้ส่งออก');
                return;
            }
            
            let csvContent = "รหัสสินค้า,ชื่อสินค้า,ประเภท,จำนวนคงเหลือ,ราคาต่อหน่วย,มูลค่ารวม\n";
            
            products.forEach(product => {
                const totalValue = product.quantity * product.price;
                csvContent += `"${product.productCode}","${product.productName}","${product.category}",${product.quantity},${product.price},${totalValue}\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            link.setAttribute("href", url);
            link.setAttribute("download", `สินค้า_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAlert('success', 'ส่งออกสำเร็จ', 'ส่งออกข้อมูลสินค้าเป็นไฟล์ CSV เรียบร้อยแล้ว');
        }
        
        // ==================== EVENT LISTENERS ====================
        
        document.addEventListener('DOMContentLoaded', function() {
            checkUserAndPermissions();
            
            // Login Form
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const username = document.getElementById('username').value.trim();
                    const password = document.getElementById('password').value.trim();
                    
                    if (!username || !password) {
                        showAlert('error', 'ข้อมูลไม่ครบถ้วน', 'กรุณากรอกชื่อผู้ใช้และรหัสผ่าน');
                        return;
                    }
                    
                    loginUser(username, password);
                });
            }
            
            // Navigation
            document.getElementById('navDashboard')?.addEventListener('click', () => showPage('dashboardPage'));
            document.getElementById('navProducts')?.addEventListener('click', () => showPage('productsPage'));
            document.getElementById('navSales')?.addEventListener('click', () => {
                if (checkPermission('canSell')) {
                    showPage('salesPage');
                } else {
                    showAlert('error', 'ไม่มีสิทธิ์', 'คุณไม่มีสิทธิ์เข้าถึงหน้านี้');
                }
            });
            document.getElementById('navSalesReport')?.addEventListener('click', () => {
                if (checkPermission('canViewSales')) {
                    showPage('salesReportPage');
                } else {
                    showAlert('error', 'ไม่มีสิทธิ์', 'คุณไม่มีสิทธิ์เข้าถึงหน้ารายงานการขาย');
                }
            });
            document.getElementById('navUsers')?.addEventListener('click', () => {
                if (checkPermission('canManageUsers')) {
                    showPage('usersPage');
                } else {
                    showAlert('error', 'ไม่มีสิทธิ์', 'คุณไม่มีสิทธิ์เข้าถึงหน้าจัดการผู้ใช้');
                }
            });
            document.getElementById('navSettings')?.addEventListener('click', () => {
                if (checkPermission('canManageSettings')) {
                    showPage('settingsPage');
                } else {
                    showAlert('error', 'ไม่มีสิทธิ์', 'คุณไม่มีสิทธิ์เข้าถึงหน้าตั้งค่าระบบ');
                }
            });
            
            document.getElementById('homeBtn')?.addEventListener('click', (e) => {
                e.preventDefault();
                showPage('dashboardPage');
            });
            
            // Products
            document.getElementById('addProductMainBtn')?.addEventListener('click', () => {
                if (checkPermission('canAdd')) {
                    showProductModal();
                } else {
                    showAlert('error', 'ไม่มีสิทธิ์', 'คุณไม่มีสิทธิ์เพิ่มสินค้า');
                }
            });
            
            document.getElementById('productForm')?.addEventListener('submit', saveProduct);
            document.getElementById('cancelProductModalBtn')?.addEventListener('click', hideProductModal);
            document.getElementById('exportProductsBtn')?.addEventListener('click', exportProducts);
            
            // Sales
            document.getElementById('newSaleBtn')?.addEventListener('click', resetCart);
            document.getElementById('clearCartBtn')?.addEventListener('click', resetCart);
            document.getElementById('completeSaleBtn')?.addEventListener('click', completeSale);
            document.getElementById('discountAmount')?.addEventListener('input', updateCartDisplay);
            
            // Sales Report
            document.getElementById('generateReportBtn')?.addEventListener('click', generateSalesReport);
            
            // Users
            document.getElementById('addUserBtn')?.addEventListener('click', () => {
                if (checkPermission('canManageUsers')) {
                    showUserModal();
                } else {
                    showAlert('error', 'ไม่มีสิทธิ์', 'คุณไม่มีสิทธิ์เพิ่มผู้ใช้');
                }
            });
            
            document.getElementById('userForm')?.addEventListener('submit', saveUser);
            document.getElementById('cancelUserModalBtn')?.addEventListener('click', hideUserModal);
            
            // Receipt
            document.getElementById('closeReceiptBtn')?.addEventListener('click', () => {
                document.getElementById('receiptModal').classList.add('hidden');
            });
            
            document.getElementById('printReceiptBtn')?.addEventListener('click', () => {
                window.print();
            });
            
            // Logout
            document.getElementById('logoutBtn')?.addEventListener('click', logout);
            
            // Settings
            document.getElementById('backupDataBtn')?.addEventListener('click', () => {
                if (checkPermission('canManageSettings')) {
                    const backupData = {
                        timestamp: new Date().toISOString(),
                        products: products,
                        users: users,
                        sales: sales
                    };
                    
                    const jsonString = JSON.stringify(backupData, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const link = document.createElement("a");
                    const url = URL.createObjectURL(blob);
                    
                    link.setAttribute("href", url);
                    link.setAttribute("download", `backup_${new Date().toISOString()}.json`);
                    link.style.visibility = 'hidden';
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showAlert('success', 'สำรองข้อมูลสำเร็จ', 'สำรองข้อมูลระบบทั้งหมดเรียบร้อยแล้ว');
                } else {
                    showAlert('error', 'ไม่มีสิทธิ์', 'คุณไม่มีสิทธิ์สำรองข้อมูล');
                }
            });
            
            document.getElementById('resetDemoDataBtn')?.addEventListener('click', () => {
                if (checkPermission('canManageSettings')) {
                    showConfirmation(
                        'รีเซ็ตข้อมูลตัวอย่าง',
                        'การดำเนินการนี้จะลบข้อมูลสินค้าทั้งหมดและสร้างข้อมูลตัวอย่างใหม่',
                        'warning',
                        'รีเซ็ตข้อมูล',
                        'ยกเลิก'
                    ).then(confirmed => {
                        if (confirmed) {
                            const demoProducts = [
                                {
                                    productCode: "P001",
                                    productName: "เมาส์ไร้สาย",
                                    category: "อิเล็กทรอนิกส์",
                                    quantity: 25,
                                    price: 599.00,
                                    createdBy: currentUser.username,
                                    createdAt: new Date().toISOString()
                                },
                                {
                                    productCode: "P002",
                                    productName: "คีย์บอร์ดเกมมิ่ง",
                                    category: "อิเล็กทรอนิกส์",
                                    quantity: 12,
                                    price: 1290.00,
                                    createdBy: currentUser.username,
                                    createdAt: new Date().toISOString()
                                }
                            ];
                            
                            showLoading('กำลังรีเซ็ตข้อมูลตัวอย่าง...');
                            
                            database.ref('products').remove()
                                .then(() => {
                                    const promises = demoProducts.map(product => {
                                        return database.ref('products').push(product);
                                    });
                                    
                                    return Promise.all(promises);
                                })
                                .then(() => {
                                    hideLoading();
                                    showAlert('success', 'รีเซ็ตสำเร็จ', 'รีเซ็ตข้อมูลตัวอย่างสำเร็จแล้ว!');
                                })
                                .catch(error => {
                                    hideLoading();
                                    showAlert('error', 'ข้อผิดพลาด', 'เกิดข้อผิดพลาดในการรีเซ็ตข้อมูลตัวอย่าง');
                                });
                        }
                    });
                } else {
                    showAlert('error', 'ไม่มีสิทธิ์', 'คุณไม่มีสิทธิ์รีเซ็ตข้อมูลตัวอย่าง');
                }
            });
            
            // Close modals on background click
            const modals = ['productModal', 'userModal', 'receiptModal', 'confirmationDialog'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.addEventListener('click', function(e) {
                        if (e.target === this) {
                            this.classList.add('hidden');
                        }
                    });
                }
            });
        });
        
        // ทำให้ฟังก์ชันสามารถเรียกใช้จาก onclick ใน HTML ได้
        window.editProduct = editProduct;
        window.showDeleteProductConfirm = showDeleteProductConfirm;
        window.editUser = editUser;
        window.showDeleteUserConfirm = showDeleteUserConfirm;
        window.addToCart = addToCart;
        window.increaseQuantity = increaseQuantity;
        window.decreaseQuantity = decreaseQuantity;
        window.removeFromCart = removeFromCart;
        window.closeAlert = closeAlert;
        window.viewReceipt = viewReceipt;
    </script>
</body>
</html>
